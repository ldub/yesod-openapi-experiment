# Yesod OpenAPI Experiment

This repository is an experiment in **spec‑driven development** for Yesod.
The OpenAPI specification is the single source of truth. Code is generated from
the spec and used as a library of stubs by the real application.

```
                                   ┌────────────────────────────┐
                             ┌────▶│    Server Implementation   │
                             │     └────────────────────────────┘
                             │     ┌────────────────────────────┐
  ┌────────────────────┐     ├────▶│         App Client         │
  │  OpenAPI Document  │─────┤     └────────────────────────────┘
  └────────────────────┘     │     ┌────────────────────────────┐
                             ├────▶│         Web Client         │
                             │     └────────────────────────────┘
                             │     ┌────────────────────────────┐
                             └────▶│            ...             │
                                   └────────────────────────────┘
```

A pretty good description of the benefits of spec-driven development lives in the [Apple's docs for their swift openapi generator](https://swiftpackageindex.com/apple/swift-openapi-generator/1.7.2/documentation/swift-openapi-generator/practicing-spec-driven-api-development#Recommended-Spec-driven-development).

Additional benefits of this for us would be the ability to use a huge ecosystem of OpenAPI-compatible developer tools and enabling testing methodoly like [contract testing](https://martinfowler.com/bliki/ContractTest.html).

## Files

- `openapi.yaml` – Minimal "Hello World" OpenAPI 3 specification exposing a single `/hello` endpoint.
- `generate.sh` – Script that invokes `openapi-generator-cli` to produce the Yesod stub code in `generated-server/`.
- `generated-server/` – Code generated by OpenAPI Generator. It can be regenerated at any time and is treated as a library of stubs.
- `server/` – Hand written Yesod project that depends on `generated-server` and implements the real handlers.

## Workflow

1. Edit **openapi.yaml** to describe the API contract.
2. Run `./generate.sh` to regenerate stubs in `generated-server/`. This folder is
   never edited by hand and can be deleted and recreated at any time.
3. Implement the real handlers inside `server/` by importing the generated
   library. The production server replaces the `notImplemented` placeholders with
   working logic.
4. Repeat from step 1 whenever you change the API.

## Usage

1. Ensure `openapi-generator` is installed and available on your `PATH`.
   You can install it via Homebrew (`brew install openapi-generator`).
   Alternatively you can use the provided Docker command inside `generate.sh`.

2. Run the generator script:

   ```bash
   ./generate.sh
   ```

   The generated stubs will be placed in `generated-server/`.

3. Build the production server inside `server/` using `stack` or `cabal`. The `stack.yaml` in that folder references the generated package as a local dependency.

Refer to the [Haskell Yesod generator documentation](https://github.com/OpenAPITools/openapi-generator/blob/master/docs/generators/haskell-yesod.md) for available options.
